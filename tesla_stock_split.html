<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet">
    <link rel="icon" href="https://imgur.com/VjN344H.png">

    <link href="https://fonts.googleapis.com/css?family=Ubuntu:300,400,500,700" rel="stylesheet">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/css/bootstrap.min.css"
        integrity="sha384-KyZXEAg3QhqLMpG8r+8fhAXLRk2vvoC2f3B09zVXn8CA5QIVfZOJ3BCsw2P0p/We" crossorigin="anonymous">

    <link rel="stylesheet" href="mycss.css">


    <style type="text/css">
        body {
            margin: 20px;
            background-color: black;
        }

        u {
            text-decoration-color: red;
        }

        .stores {
            margin-top: 40px;
        }
    </style>
</head>


<body>


    <nav class="navbar">

        <a href="index.html"><img src="heading___logo_tesla.png" class="teslanavbar" /></a>

    </nav>


    <hr class="headerline" />


    <div class="col-md-12 col-lg-12 col-sm-12">


        <h3 class="bigtextwhite lato font-weight-bold">Get an email alert before Tesla has a stock split</h3>


        <img width="120" src="tesla.jpg" alt="App Store image" class="teslaImage center" />


        <h3 class="teslaHeading latoNormal">Stock Notfications for Tesla investors</h3>

        <div class="form">
            <input type="email" id="email" pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,4}$" required
                class="center-block form-control email" aria-describedby="emailHelp" placeholder="Enter email">
        </div>

        <button id="submitButton" type="button" class="center-block teslaButton btn btn-primary">SUBMIT</button>

    </div>

    <script type="module">

        import {initializeApp} from "https://www.gstatic.com/firebasejs/9.2.0/firebase-app.js";
        import {getAnalytics} from "https://www.gstatic.com/firebasejs/9.2.0/firebase-analytics.js";
        import {getAuth, signInAnonymously, onAuthStateChanged} from "https://www.gstatic.com/firebasejs/9.2.0/firebase-auth.js";

        import {getDatabase, ref, set, child, update, remove} from "https://www.gstatic.com/firebasejs/9.2.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBWoanAOoR7pizrMD5d8DwVUQefAh6isnM",
            authDomain: "smart-notifications-marketing.firebaseapp.com",
            databaseURL: "https://smart-notifications-marketing-default-rtdb.firebaseio.com",
            projectId: "smart-notifications-marketing",
            storageBucket: "smart-notifications-marketing.appspot.com",
            messagingSenderId: "377643408726",
            appId: "1:377643408726:web:2fcbfcc73b6f2b8bd08af7",
            measurementId: "G-23Q6LCW38C"
        };
        //todo
        //check email is valid
        //show a sucsses message & remove input 
        //add the correct alarm object 
        //after the notfication is set it says download our app for more alarms 
        //prevent multiple of the same alarm being set 


        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);

        var emailInput = document.getElementById("email");
        var createAlarmBtn = document.getElementById("submitButton");



        function addUser(alarmUUID, time) {
           
            set(ref(db, '/users/' + uid), {
                email: alarmUUID,
                notificationType: 'EVENT',
                subscriptionType: "FREE",
                reminded: true,
                timeCreated: time,
            }).then(() => {
                alert("Saved data");
            })
            .catch((error) => {
                alert("error : " + error);
            });
        }


        async function insetData() {
            const isValidEmail = emailInput.checkValidity();

            if (isValidEmail) {
 
                const db = getDatabase();

                const alarmID = create_UUID();

                const d = new Date();
                let time = d.getTime();

                await set(ref(db, '/alarms/' + alarmID), {
                    alarmID: alarmID,
                    notificationType: 'EVENT',
                    alarmOn: true,
                    alarmTriggerCategory: 'EVENT',
                    initialAmount: 'initialAmount',
                    current: 'initialAmount',
                    extendedHours: false,
                    companyLogo: 'https://a57.foxnews.com/static.foxnews.com/foxnews.com/content/uploads/2020/06/931/524/TESLA-LOGO.jpg?ve=1&tl=1',
                    stockName: 'Tesla Inc',
                    lowerLimit: 'lowerLimit',
                    subscriptionStatus: false,
                    targetPrice: null,
                    targetHit: null,
                    upperLimit: null,
                    stockId: 'TSLA',
                    alarmDescription: 'Triggered before Tesla has a stock split',
                    testCurrent: 0,
                    timeUpdated: time,
                    userID: uid,
                }).then(() => {
                    alert("add user : " + error);
                    addUser(alarmID, time);
                })
                .catch((error) => {
                    alert("error : " + error);
                    addUser(alarmID, time);
                });
            }
        }

        function create_UUID() {
            var dt = new Date().getTime();
            var uuid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                var r = (dt + Math.random() * 16) % 16 | 0;
                dt = Math.floor(dt / 16);
                return (c == 'x' ? r : (r & 0x3 | 0x8)).toString(16);
            });
            return uuid;
        }

        const auth = getAuth();
        var uid = "";


        signInAnonymously(auth)
            .then(() => {
                console.log("Signed in");
            })
            .catch((error) => {
                const errorCode = error.code;
                const errorMessage = error.message;
                alert("errorMessage : " + errorMessage);
            });
        onAuthStateChanged(auth, (user) => {
            if (user) {
                uid = user.uid;
            } else {
                alert("errorMessage : ");
            }
        });

        createAlarmBtn.addEventListener('click', insetData)


    </script>




</body>



</html>